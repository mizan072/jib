<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>মাহে রমজান ২০২৬ - মেহেরপুর</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f3d3e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ramadan 26">
    
    <!-- Embedded Manifest (Data URI) to guarantee detection -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIlJhbWFkYW4gMjAyNiBNZWhlcnB1ciIsCiAgInNob3J0X25hbWUiOiAiUmFtYWRhbiAyNiIsCiAgInN0YXJ0X3VybCI6ICIuL2luZGV4Lmh0bWwiLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwZjNkM2UiLAogICJ0aGVtZV9jb2xvciI6ICIjMGYzZDNlIiwKICAiZGVzY3JpcHRpb24iOiAiUmFtYWRhbiBDYWxlbmRhciAyMDI2IGZvciBNZWhlcnB1ciBEaXN0cmljdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vdmlhLnBsYWNlaG9sZGVyLmNvbS8xOTIvMGYzZDNlL2ZmZmZmZj90ZXh0PVJhbWFkYW4iLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly92aWEucGxhY2Vob2xkZXIuY29tLzUxMi8wZjNkM2UvZmZmZmZmP3RleHQ9UmFtYWRhbiIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQ==">

    <link rel="apple-touch-icon" href="https://via.placeholder.com/192/0f3d3e/ffffff?text=Ramadan">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Noto+Sans+Bengali:wght@300;400;500;600;700;800&family=Noto+Serif+Bengali:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        // --- PWA LOGIC START ---
        let deferredPrompt;

        // 1. Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(r=>console.log('SW Registered')).catch(e=>console.log('SW Fail',e));
            });
        }

        // 2. Listen for Install Event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('Install prompt captured');
        });

        // 3. Helper to detect iOS
        const isIOS = () => /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        // 4. Check if already installed
        const isStandalone = () => (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone) || document.referrer.includes('android-app://');
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        islamic: {
                            base: '#0f3d3e', light: '#185a5b', gold: '#d4af37', cream: '#f8f5e6', accent: '#cfa86e', red: '#e74c3c'
                        }
                    },
                    fontFamily: {
                        bangla: ['"Noto Sans Bengali"', 'sans-serif'],
                        title: ['"Noto Serif Bengali"', 'serif'],
                        arabic: ['"Amiri"', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8f5e6;
            font-family: 'Noto Sans Bengali', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-image: radial-gradient(#d4af37 0.5px, transparent 0.5px), radial-gradient(#d4af37 0.5px, #f8f5e6 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            background-attachment: fixed;
            overflow-x: hidden;
        }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        ::-webkit-scrollbar-thumb { background: #185a5b; border-radius: 10px; }

        .glass-card {
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow: 0 10px 15px -3px rgba(15, 61, 62, 0.1), 0 4px 6px -2px rgba(15, 61, 62, 0.05);
        }

        .active-row { background-color: #e0f2f1; border-left: 4px solid #0f3d3e; }
        .click-effect { animation: pulse-gold 0.2s ease-in-out; }
        @keyframes pulse-gold { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
        .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-item.active { color: #0f3d3e; }
        .nav-item.active i { transform: translateY(-4px); color: #d4af37; filter: drop-shadow(0 4px 6px rgba(212, 175, 55, 0.4)); }
        .bengali-num { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
        
        /* Compass */
        .compass-container { position: relative; width: 280px; height: 280px; margin: 0 auto; border-radius: 50%; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 8px solid #f0f0f0; transition: transform 0.1s ease-out; }
        .compass-dial { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='none' stroke='%23ddd' stroke-width='1'/%3E%3Ctext x='50' y='12' font-family='Arial' font-size='8' text-anchor='middle' fill='%23999'%3EN%3C/text%3E%3Ctext x='50' y='92' font-family='Arial' font-size='8' text-anchor='middle' fill='%23999'%3ES%3C/text%3E%3Ctext x='92' y='53' font-family='Arial' font-size='8' text-anchor='middle' fill='%23999'%3EE%3C/text%3E%3Ctext x='8' y='53' font-family='Arial' font-size='8' text-anchor='middle' fill='%23999'%3EW%3C/text%3E%3Cpath d='M50 20 L50 25 M50 75 L50 80 M20 50 L25 50 M75 50 L80 50' stroke='%23ccc' stroke-width='2'/%3E%3C/svg%3E"); background-size: cover; border-radius: 50%; }
        .qibla-pointer { position: absolute; top: 50%; left: 50%; width: 6px; height: 110px; background: transparent; transform-origin: bottom center; z-index: 10; transition: transform 0.3s cubic-bezier(0.4, 2.08, 0.55, 0.44); }
        .qibla-arrow-head { position: absolute; top: 0; left: -12px; width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 40px solid #d4af37; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .kaaba-icon-dial { position: absolute; top: -35px; left: -10px; font-size: 24px; color: black; animation: pulse-slow 2s infinite; }
        @keyframes pulse-slow { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen text-slate-800 flex flex-col items-center pb-24">

    <!-- Audio for Alarm -->
    <audio id="alarm-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/936/936-preview.mp3" type="audio/mpeg">
    </audio>

    <!-- Header -->
    <header class="w-full bg-islamic-base text-islamic-cream pt-10 pb-16 px-4 rounded-b-[2.5rem] shadow-xl relative overflow-hidden shrink-0">
        <!-- Install Button -->
        <button id="install-btn" onclick="attemptInstall()" class="absolute top-4 right-4 bg-islamic-gold text-islamic-base px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 shadow-lg hover:bg-white transition z-50 animate-bounce">
            <i class="fas fa-download"></i> ইনস্টল
        </button>

        <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
            <svg width="100%" height="100%">
                <pattern id="pattern-circles" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                    <path d="M20 0 L40 20 L20 40 L0 20 Z" fill="none" stroke="currentColor" stroke-width="1"/>
                </pattern>
                <rect x="0" y="0" width="100%" height="100%" fill="url(#pattern-circles)"></rect>
            </svg>
        </div>
        <div class="max-w-md mx-auto text-center relative z-10">
            <div class="flex justify-center mb-3">
                <div class="w-16 h-16 bg-islamic-light/30 rounded-full flex items-center justify-center border border-islamic-gold/30 backdrop-blur-sm">
                    <i class="fas fa-mosque text-3xl text-islamic-gold"></i>
                </div>
            </div>
            <h1 class="text-3xl font-bold font-title mb-2 drop-shadow-md tracking-wide">রমজান ক্যালেন্ডার</h1>
            <p class="text-islamic-accent text-base font-semibold tracking-wider bg-black/10 inline-block px-4 py-1 rounded-full">মেহেরপুর জেলা - ২০২৬</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="w-full max-w-md px-4 -mt-10 z-20 flex-grow relative">

        <!-- VIEW 1: HOME -->
        <div id="view-home" class="tab-content active space-y-4">
            <div class="glass-card rounded-2xl p-6 text-center shadow-lg relative">
                <button id="alarm-toggle" onclick="toggleAlarm()" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 hover:bg-gray-200 transition-all shadow-sm z-20">
                    <i class="fas fa-bell-slash text-lg"></i>
                </button>
                <div class="flex items-center justify-between mb-2 border-b border-gray-100 pb-2 pr-12">
                    <h2 id="status-title" class="text-lg font-bold text-islamic-base">আজকের সময়সূচি</h2>
                    <span id="current-date-display" class="text-sm text-gray-500 font-semibold bg-gray-100 px-3 py-1 rounded-full shadow-sm">--</span>
                </div>
                <div id="countdown-container" class="py-4">
                    <div class="text-5xl font-bold text-islamic-base font-mono tracking-wider bengali-num drop-shadow-sm" id="countdown-timer">--:--:--</div>
                    <p id="next-event-label" class="text-sm text-gray-500 mt-2 font-medium">অপেক্ষা করুন...</p>
                </div>
                <div class="grid grid-cols-3 gap-3 mt-2">
                    <div class="flex flex-col items-center p-3 bg-emerald-50 rounded-xl border border-emerald-100">
                        <i class="fas fa-cloud-moon text-emerald-700 mb-1"></i>
                        <span class="text-xs text-gray-500 font-bold">সাহরী শেষ</span>
                        <span id="today-sehri" class="text-xl font-bold text-islamic-base bengali-num mt-1">--:--</span>
                    </div>
                    <div class="flex flex-col items-center p-3 bg-yellow-50 rounded-xl border border-yellow-100">
                        <i class="fas fa-sun text-yellow-600 mb-1"></i>
                        <span class="text-xs text-gray-500 font-bold">ইফতার</span>
                        <span id="today-iftar" class="text-xl font-bold text-islamic-base bengali-num mt-1">--:--</span>
                    </div>
                    <div class="flex flex-col items-center p-3 bg-blue-50 rounded-xl border border-blue-100">
                        <i class="fas fa-pray text-blue-600 mb-1"></i>
                        <span class="text-xs text-gray-500 font-bold">ফজর</span>
                        <span id="today-fajr" class="text-xl font-bold text-islamic-base bengali-num mt-1">--:--</span>
                    </div>
                </div>
            </div>
            <div class="glass-card rounded-2xl p-5 bg-gradient-to-r from-islamic-base to-islamic-light text-white shadow-lg relative overflow-hidden">
                <i class="fas fa-hands-praying absolute -right-4 -bottom-4 text-8xl text-white opacity-5"></i>
                <div class="relative z-10">
                    <h3 class="font-bold text-islamic-gold text-sm mb-2 flex items-center gap-2">
                        <i class="fas fa-star text-xs"></i> ইফতারের দোয়া
                    </h3>
                    <p class="font-arabic text-xl leading-relaxed text-right mb-2" dir="rtl">اَللّٰهُمَّ لَكَ صُمْتُ وَ عَلَى رِزْقِكَ اَفْطَرْتُ</p>
                    <p class="text-sm opacity-90 leading-tight">হে আল্লাহ! আমি তোমারই জন্য রোজা রেখেছি এবং তোমারই দেওয়া রিযিক দ্বারা ইফতার করছি।</p>
                </div>
            </div>
            <div class="glass-card rounded-2xl overflow-hidden shadow-md border-0">
                <div class="bg-gray-50 px-5 py-3 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
                    <h3 class="font-bold text-gray-700 font-title">পুরো মাসের সময়সূচি</h3>
                    <div class="text-xs bg-white border border-gray-200 px-2 py-1 rounded text-gray-500 font-bold">২০২৬</div>
                </div>
                <div class="overflow-x-auto max-h-[400px] overflow-y-auto relative">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-600 uppercase bg-gray-100 sticky top-0 z-10 shadow-sm font-bold">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-center w-16">রোজা</th>
                                <th scope="col" class="px-4 py-3">তারিখ</th>
                                <th scope="col" class="px-4 py-3 text-center">সাহরী</th>
                                <th scope="col" class="px-4 py-3 text-center">ইফতার</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body" class="divide-y divide-gray-100 bg-white">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="p-3 text-xs text-gray-500 text-center leading-relaxed bg-white/60 rounded-xl border border-gray-100 mb-6 font-medium">
                <p><span class="text-red-500 font-bold">*</span> ১লা রমজান চাঁদ দেখার উপর নির্ভরশীল।</p>
            </div>
        </div>

        <!-- VIEW 2: TASBIH -->
        <div id="view-tasbih" class="tab-content space-y-6">
            <div class="glass-card rounded-2xl p-8 text-center shadow-lg mt-4 flex flex-col items-center justify-center min-h-[400px]">
                <h2 class="text-xl font-bold text-islamic-base mb-6 font-title">ডিজিটাল তসবিহ</h2>
                <div class="w-48 h-48 rounded-full border-8 border-islamic-light flex items-center justify-center bg-gray-50 shadow-inner mb-8 relative">
                    <span id="tasbih-count" class="text-6xl font-bold text-islamic-base font-mono">০</span>
                    <div class="absolute -top-3 bg-white px-3 py-1 rounded-full text-xs font-bold text-gray-400 border border-gray-200 shadow-sm">COUNT</div>
                </div>
                <div class="grid grid-cols-2 gap-4 w-full max-w-xs">
                    <button onclick="resetTasbih()" class="py-3 px-6 rounded-xl bg-gray-200 text-gray-600 font-bold hover:bg-gray-300 transition shadow-sm">
                        <i class="fas fa-undo mr-2"></i>রিসেট
                    </button>
                    <button id="tasbih-btn" onclick="incrementTasbih()" class="py-3 px-6 rounded-xl bg-islamic-base text-white font-bold hover:bg-islamic-light transition shadow-lg transform active:scale-95">
                        <i class="fas fa-plus mr-2"></i>গণনা
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW 3: QIBLA -->
        <div id="view-qibla" class="tab-content space-y-6">
            <div class="glass-card rounded-2xl p-6 text-center shadow-lg mt-4">
                <h2 class="text-xl font-bold text-islamic-base mb-2 font-title">কিবলা কম্পাস</h2>
                <p class="text-sm text-gray-500 mb-4 font-medium">আপনার ফোনটি সমান্তরালভাবে ধরুন</p>
                <div class="compass-container relative mb-4">
                    <div id="compass-dial" class="compass-dial"></div>
                    <div id="qibla-pointer" class="qibla-pointer" style="transform: rotate(0deg);">
                        <div class="qibla-arrow-head"></div>
                        <div class="kaaba-icon-dial"><i class="fas fa-kaaba"></i></div>
                    </div>
                    <div class="absolute top-1/2 left-1/2 w-4 h-4 bg-islamic-base rounded-full transform -translate-x-1/2 -translate-y-1/2 border-2 border-white z-20 shadow-md"></div>
                </div>
                <button id="start-compass-btn" onclick="initCompass()" class="w-full py-3 bg-islamic-base text-white rounded-xl font-bold shadow-md hover:bg-islamic-light transition mb-4">
                    <i class="fas fa-compass mr-2"></i> কম্পাস চালু করুন
                </button>
                <div class="bg-yellow-50 p-4 rounded-lg text-sm text-yellow-800 border border-yellow-200 font-medium text-left">
                     <p class="mb-1"><i class="fas fa-info-circle mr-1"></i> <strong>নির্দেশনা:</strong></p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>গোল্ডেন অ্যারো (তীর) টি কাবার দিক নির্দেশ করে।</li>
                        <li>এটি কাজ করতে আপনার ফোনের সেন্সর প্রয়োজন।</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="text-center py-6 mt-4 text-islamic-base font-semibold text-base">
            ডেভেলপড বাই মিজানুর রহমান
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 px-6 py-2 flex justify-around items-end z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] pb-safe">
        <button onclick="switchTab('home')" class="nav-item active flex flex-col items-center p-2 text-gray-400 transition-all duration-300 w-1/3 group">
            <i class="fas fa-home text-xl mb-1 group-hover:text-islamic-base transition-colors"></i>
            <span class="text-[10px] font-bold">হোম</span>
        </button>
        <button onclick="switchTab('tasbih')" class="nav-item flex flex-col items-center p-2 text-gray-400 transition-all duration-300 w-1/3 group">
            <i class="fas fa-fingerprint text-xl mb-1 group-hover:text-islamic-base transition-colors"></i>
            <span class="text-[10px] font-bold">তসবিহ</span>
        </button>
        <button onclick="switchTab('qibla')" class="nav-item flex flex-col items-center p-2 text-gray-400 transition-all duration-300 w-1/3 group">
            <i class="fas fa-compass text-xl mb-1 group-hover:text-islamic-base transition-colors"></i>
            <span class="text-[10px] font-bold">কিবলা</span>
        </button>
    </nav>

    <!-- Alarm Modal -->
    <div id="alarm-modal" class="fixed inset-0 z-[60] flex items-center justify-center px-4 pointer-events-none opacity-0 transition-opacity duration-300">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeAlarmModal()"></div>
        <div class="glass-card w-full max-w-sm p-6 rounded-2xl text-center relative transform scale-90 transition-transform duration-300 z-10 bg-white border-2 border-islamic-gold">
            <div class="w-20 h-20 bg-islamic-gold/20 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                <i class="fas fa-utensils text-4xl text-islamic-gold"></i>
            </div>
            <h2 class="text-2xl font-bold text-islamic-base mb-2 font-title">ইফতারের সময় হয়েছে!</h2>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-6">
                <p class="font-arabic text-xl leading-loose text-center text-islamic-base" dir="rtl">اَللّٰهُمَّ لَكَ صُمْتُ وَ عَلَى رِزْقِكَ اَفْطَرْتُ</p>
                <p class="text-xs text-gray-500 mt-2">হে আল্লাহ! আমি তোমারই জন্য রোজা রেখেছি এবং তোমারই দেওয়া রিযিক দ্বারা ইফতার করছি।</p>
            </div>
            <button onclick="closeAlarmModal()" class="w-full py-3 bg-islamic-base text-white rounded-xl font-bold shadow-lg hover:bg-islamic-light transition">
                আলহামদুলিল্লাহ
            </button>
        </div>
    </div>

    <!-- Installation Instructions Modal -->
    <div id="install-instructions-modal" class="fixed inset-0 z-[70] flex items-center justify-center px-4 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeInstallModal()"></div>
        <div class="bg-white w-full max-w-xs p-6 rounded-3xl text-center relative z-10 animate-slide-up">
            <button onclick="closeInstallModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            
            <div id="ios-instructions" class="hidden">
                <i class="fab fa-apple text-4xl text-gray-800 mb-4"></i>
                <h3 class="text-lg font-bold mb-2">আইফোনে ইনস্টল করুন</h3>
                <div class="text-sm text-gray-600 space-y-4 text-left px-2">
                    <p>১. নিচে থাকা <span class="font-bold text-blue-500"><i class="fas fa-share-square"></i> Share</span> বাটনে ক্লিক করুন।</p>
                    <p>২. অপশন থেকে <span class="font-bold text-gray-800"><i class="fas fa-plus-square"></i> Add to Home Screen</span> বেছে নিন।</p>
                    <p>৩. উপরে থাকা <span class="font-bold">Add</span> বাটনে চাপ দিন।</p>
                </div>
            </div>

            <div id="android-instructions" class="hidden">
                <i class="fab fa-android text-4xl text-green-600 mb-4"></i>
                <h3 class="text-lg font-bold mb-2">ইনস্টল করার নিয়ম</h3>
                <div class="text-sm text-gray-600 space-y-4 text-left px-2">
                    <p>১. ব্রাউজারের মেনুতে (<i class="fas fa-ellipsis-v"></i>) ক্লিক করুন।</p>
                    <p>২. <span class="font-bold"><i class="fas fa-mobile-alt"></i> Install App</span> অথবা <span class="font-bold">Add to Home screen</span> এ ক্লিক করুন।</p>
                    <p>৩. নিশ্চিত করতে Install এ চাপ দিন।</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data ---
        const scheduleData = [
            { r: 1, d: "১৯ ফেব্রুয়ারি", date: "2026-02-19", s: "05:19", f: "05:21", i: "18:04", first: true },
            { r: 2, d: "২০ ফেব্রুয়ারি", date: "2026-02-20", s: "05:18", f: "05:20", i: "18:04" },
            { r: 3, d: "২১ ফেব্রুয়ারি", date: "2026-02-21", s: "05:17", f: "05:19", i: "18:05" },
            { r: 4, d: "২২ ফেব্রুয়ারি", date: "2026-02-22", s: "05:16", f: "05:19", i: "18:05" },
            { r: 5, d: "২৩ ফেব্রুয়ারি", date: "2026-02-23", s: "05:16", f: "05:18", i: "18:06" },
            { r: 6, d: "২৪ ফেব্রুয়ারি", date: "2026-02-24", s: "05:15", f: "05:17", i: "18:06" },
            { r: 7, d: "২৫ ফেব্রুয়ারি", date: "2026-02-25", s: "05:14", f: "05:16", i: "18:07" },
            { r: 8, d: "২৬ ফেব্রুয়ারি", date: "2026-02-26", s: "05:13", f: "05:16", i: "18:07" },
            { r: 9, d: "২৭ ফেব্রুয়ারি", date: "2026-02-27", s: "05:13", f: "05:15", i: "18:08" },
            { r: 10, d: "২৮ ফেব্রুয়ারি", date: "2026-02-28", s: "05:12", f: "05:14", i: "18:08" },
            { r: 11, d: "০১ মার্চ", date: "2026-03-01", s: "05:11", f: "05:13", i: "18:09" },
            { r: 12, d: "০২ মার্চ", date: "2026-03-02", s: "05:10", f: "05:12", i: "18:09" },
            { r: 13, d: "০৩ মার্চ", date: "2026-03-03", s: "05:09", f: "05:12", i: "18:10" },
            { r: 14, d: "০৪ মার্চ", date: "2026-03-04", s: "05:08", f: "05:11", i: "18:10" },
            { r: 15, d: "০৫ মার্চ", date: "2026-03-05", s: "05:08", f: "05:10", i: "18:11" },
            { r: 16, d: "০৬ মার্চ", date: "2026-03-06", s: "05:07", f: "05:09", i: "18:11" },
            { r: 17, d: "০৭ মার্চ", date: "2026-03-07", s: "05:06", f: "05:08", i: "18:12" },
            { r: 18, d: "০৮ মার্চ", date: "2026-03-08", s: "05:05", f: "05:07", i: "18:12" },
            { r: 19, d: "০৯ মার্চ", date: "2026-03-09", s: "05:04", f: "05:06", i: "18:12" },
            { r: 20, d: "১০ মার্চ", date: "2026-03-10", s: "05:03", f: "05:05", i: "18:13" },
            { r: 21, d: "১১ মার্চ", date: "2026-03-11", s: "05:02", f: "05:04", i: "18:13" },
            { r: 22, d: "১২ মার্চ", date: "2026-03-12", s: "05:01", f: "05:03", i: "18:14" },
            { r: 23, d: "১৩ মার্চ", date: "2026-03-13", s: "05:00", f: "05:02", i: "18:14" },
            { r: 24, d: "১৪ মার্চ", date: "2026-03-14", s: "04:59", f: "05:01", i: "18:15" },
            { r: 25, d: "১৫ মার্চ", date: "2026-03-15", s: "04:58", f: "05:00", i: "18:15" },
            { r: 26, d: "১৬ মার্চ", date: "2026-03-16", s: "04:57", f: "04:59", i: "18:15" },
            { r: 27, d: "১৭ মার্চ", date: "2026-03-17", s: "04:56", f: "04:58", i: "18:16" },
            { r: 28, d: "১৮ মার্চ", date: "2026-03-18", s: "04:55", f: "04:57", i: "18:16" },
            { r: 29, d: "১৯ মার্চ", date: "2026-03-19", s: "04:54", f: "04:56", i: "18:17" },
            { r: 30, d: "২০ মার্চ", date: "2026-03-20", s: "04:53", f: "04:55", i: "18:17" }
        ];

        let tasbihCount = 0;
        let alarmEnabled = false;
        let alarmPlayedToday = false;
        const QIBLA_OFFSET = 270; 

        // --- Install UI Logic ---
        function attemptInstall() {
            if (deferredPrompt) {
                // If the browser successfully captured the install event (Android/Desktop Chrome)
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        document.getElementById('install-btn').style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            } else {
                // Fallback: Show instructions
                const modal = document.getElementById('install-instructions-modal');
                const iosInstr = document.getElementById('ios-instructions');
                const androidInstr = document.getElementById('android-instructions');
                
                modal.classList.remove('hidden');
                
                if (isIOS()) {
                    iosInstr.classList.remove('hidden');
                    androidInstr.classList.add('hidden');
                } else {
                    // Default to Android/Desktop instructions
                    androidInstr.classList.remove('hidden');
                    iosInstr.classList.add('hidden');
                }
            }
        }

        function closeInstallModal() {
            document.getElementById('install-instructions-modal').classList.add('hidden');
        }

        // --- App Logic ---
        const toBengaliNum = (n) => String(n).replace(/[0-9]/g, m => ({'0':'০','1':'১','2':'২','3':'৩','4':'৪','5':'৫','6':'৬','7':'৭','8':'৮','9':'৯'})[m]);
        const formatTime = (timeStr) => {
            if(!timeStr) return '--:--';
            let [h, m] = timeStr.split(':'), hour = parseInt(h);
            if(hour > 12) hour -= 12; else if(hour === 0) hour = 12;
            return toBengaliNum(hour) + ':' + toBengaliNum(m);
        };

        function initApp() {
            renderSchedule();
            loadSettings();
            setInterval(tick, 1000);
            tick();
            
            // Hide install button if already installed
            if (isStandalone()) {
                document.getElementById('install-btn').style.display = 'none';
            }
        }

        function loadSettings() {
            const savedCount = localStorage.getItem('tasbihCount');
            if(savedCount) { tasbihCount = parseInt(savedCount); document.getElementById('tasbih-count').innerText = toBengaliNum(tasbihCount); }
            const savedAlarm = localStorage.getItem('alarmEnabled');
            alarmEnabled = savedAlarm === 'true';
            updateAlarmUI();
        }

        function tick() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            let todaysData = scheduleData.find(d => d.date === todayStr);
            let nextRamadanDay = !todaysData ? scheduleData.find(d => new Date(d.date) >= new Date(todayStr)) : null;

            updateCountdown(now, todaysData, nextRamadanDay);
            updateDashboard(todaysData, nextRamadanDay);
            
            if(todaysData && alarmEnabled && !alarmPlayedToday) {
                const iftarTime = new Date(`${todaysData.date}T${todaysData.i}:00`);
                if(now >= iftarTime && now < new Date(iftarTime.getTime() + 60000)) triggerAlarm();
            }
            if(now.getHours() === 0 && now.getMinutes() === 0 && now.getSeconds() === 0) alarmPlayedToday = false;
        }

        function renderSchedule() {
            const tbody = document.getElementById('schedule-body');
            const todayStr = new Date().toISOString().split('T')[0];
            scheduleData.forEach(day => {
                const isToday = day.date === todayStr;
                const row = document.createElement('tr');
                row.className = isToday ? 'active-row font-bold' : 'hover:bg-gray-50 border-b border-gray-50';
                let rDisplay = toBengaliNum(day.r);
                if(day.first) rDisplay = `<span class="text-islamic-gold text-xs mr-1"><i class="fas fa-star"></i></span>${rDisplay}`;
                row.innerHTML = `<td class="px-4 py-3 text-center text-islamic-base font-medium">${rDisplay}</td><td class="px-4 py-3 text-gray-700 whitespace-nowrap text-base font-medium">${day.d}</td><td class="px-4 py-3 text-center text-gray-800 text-base font-semibold">${formatTime(day.s)}</td><td class="px-4 py-3 text-center text-gray-800 text-base font-semibold">${formatTime(day.i)}</td>`;
                tbody.appendChild(row);
                if(isToday) setTimeout(() => row.scrollIntoView({behavior:'smooth',block:'center'}),500);
            });
        }

        function updateDashboard(today, next) {
            document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('bn-BD', {weekday:'short',day:'numeric',month:'long'});
            if(today || next) {
                const data = today || next;
                document.getElementById('today-sehri').innerText = formatTime(data.s);
                document.getElementById('today-fajr').innerText = formatTime(data.f);
                document.getElementById('today-iftar').innerText = formatTime(data.i);
                if(next && !today) document.getElementById('status-title').innerText = "আসন্ন রমজান";
            }
        }

        function updateCountdown(now, today, next) {
            const timerEl = document.getElementById('countdown-timer'), labelEl = document.getElementById('next-event-label');
            if(today) {
                const sTime = new Date(`${today.date}T${today.s}:00`), iTime = new Date(`${today.date}T${today.i}:00`);
                if(now < sTime) { showDiff(sTime-now, timerEl); labelEl.innerText = "সাহরীর শেষ সময়ের বাকি"; labelEl.className="text-sm text-emerald-600 mt-2 font-bold"; timerEl.className="text-5xl font-bold text-emerald-700 font-mono tracking-wider bengali-num"; }
                else if(now < iTime) { showDiff(iTime-now, timerEl); labelEl.innerText = "ইফতারের বাকি"; labelEl.className="text-sm text-orange-600 mt-2 font-bold"; timerEl.className="text-5xl font-bold text-orange-600 font-mono tracking-wider bengali-num"; }
                else { timerEl.innerText="আলহামদুলিল্লাহ"; labelEl.innerText="আজকের রোজা সম্পন্ন"; timerEl.className="text-3xl font-bold text-islamic-base font-title mt-4"; }
            } else if(next) {
                const start = new Date(`${next.date}T${next.s}:00`);
                if(now < start) { showDiff(start-now, timerEl); labelEl.innerText="প্রথম রোজার সাহরীর বাকি"; }
            }
        }

        function showDiff(ms, el) {
            if(ms<0) return;
            const h=Math.floor(ms/3600000), m=Math.floor((ms%3600000)/60000), s=Math.floor((ms%60000)/1000);
            el.innerText = `${toBengaliNum(String(h).padStart(2,'0'))}:${toBengaliNum(String(m).padStart(2,'0'))}:${toBengaliNum(String(s).padStart(2,'0'))}`;
        }

        function toggleAlarm() {
            alarmEnabled = !alarmEnabled; localStorage.setItem('alarmEnabled', alarmEnabled); updateAlarmUI();
            if(alarmEnabled) { const a = document.getElementById('alarm-sound'); a.volume=0; a.play().then(()=>{a.pause();a.currentTime=0;a.volume=1;}).catch(()=>{}); }
        }
        function updateAlarmUI() {
            const btn = document.getElementById('alarm-toggle');
            if(alarmEnabled) { btn.innerHTML='<i class="fas fa-bell text-islamic-gold"></i>'; btn.classList.add('bg-islamic-base'); btn.classList.remove('bg-gray-100','text-gray-400'); }
            else { btn.innerHTML='<i class="fas fa-bell-slash"></i>'; btn.classList.add('bg-gray-100','text-gray-400'); btn.classList.remove('bg-islamic-base'); }
        }
        function triggerAlarm() {
            alarmPlayedToday = true; document.getElementById('alarm-sound').play().catch(()=>{});
            const m = document.getElementById('alarm-modal'); m.classList.remove('pointer-events-none','opacity-0'); m.querySelector('.glass-card').classList.remove('scale-90');
            if(navigator.vibrate) navigator.vibrate([500,200,500]);
        }
        function closeAlarmModal() {
            const m = document.getElementById('alarm-modal'); m.classList.add('pointer-events-none','opacity-0'); m.querySelector('.glass-card').classList.add('scale-90');
            const a = document.getElementById('alarm-sound'); a.pause(); a.currentTime=0;
        }

        function initCompass() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(r => { if(r==='granted') window.addEventListener('deviceorientation', handleOrientation, true); }).catch(console.error);
            } else { window.addEventListener('deviceorientationabsolute', handleOrientation, true); window.addEventListener('deviceorientation', handleOrientation, true); }
            document.getElementById('start-compass-btn').style.display='none';
        }
        function handleOrientation(e) {
            let alpha = e.webkitCompassHeading || (e.alpha ? 360 - e.alpha : 0);
            if(!alpha) return;
            document.getElementById('qibla-pointer').style.transform = `rotate(${QIBLA_OFFSET - alpha}deg)`;
            document.getElementById('compass-dial').style.transform = `rotate(${-alpha}deg)`;
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById(`view-${t}`).classList.add('active');
            const idx = t==='home'?0:t==='tasbih'?1:2; document.querySelectorAll('.nav-item')[idx].classList.add('active');
            window.scrollTo({top:0,behavior:'smooth'});
        }
        function incrementTasbih() { tasbihCount++; updateTasbihUI(); if(navigator.vibrate) navigator.vibrate(20); }
        function resetTasbih() { if(confirm('রিসেট করবেন?')) { tasbihCount=0; updateTasbihUI(); } }
        function updateTasbihUI() { document.getElementById('tasbih-count').innerText = toBengaliNum(tasbihCount); localStorage.setItem('tasbihCount', tasbihCount); }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
