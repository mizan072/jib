<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reel Bot Pro | Cinematic Generator</title>
    
    <meta name="theme-color" content="#020617">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            font-family: 'Hind Siliguri', sans-serif; 
            background-color: #020617; 
            color: #f8fafc; 
            user-select: none; 
            -webkit-user-select: none; 
            overflow-x: hidden;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .loader { 
            border: 3px solid rgba(255,255,255,0.1); 
            border-top: 3px solid #3b82f6; 
            border-radius: 50%; 
            width: 24px; height: 24px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        input[type=range].timeline { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range].timeline::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ef4444; cursor: pointer; margin-top: -6px; box-shadow: 0 0 12px rgba(239, 68, 68, 0.6); transition: transform 0.1s; }
        input[type=range].timeline::-webkit-slider-thumb:active { transform: scale(1.2); }
        input[type=range].timeline::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        
        .export-btn-ready {
            background: linear-gradient(45deg, #e11d48, #be123c, #e11d48);
            background-size: 200% 200%;
            animation: gradientMove 3s ease infinite;
            box-shadow: 0 4px 15px rgba(225, 29, 72, 0.4);
        }
        @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    </style>
</head>
<body oncontextmenu="return false;">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbztp3j5Kh1tmcMcQpXfgNp9mhYQRchm2iSB-fPAk-V5ikDcXHcJlmVJ-yb93iIiycJ7/exec"; 
        const DOWNLOAD_COST = 5; 
        const VIDEO_DURATION_SEC = 8; 
        const FPS = 60; 

        // --- ICONS ---
        const IconLogo = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14v-4z"/><rect x="3" y="6" width="12" height="12" rx="2" ry="2"/></svg>;
        const IconCoin = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="gold" stroke="#b45309" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 18V6"></path></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const IconPause = () => <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>;
        const IconVideo = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>;
        const IconClose = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const IconNews = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"></path><path d="M18 14h-8"></path><path d="M15 18h-5"></path><path d="M10 6h8v4h-8V6Z"></path></svg>;
        const IconMatch = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z"></path></svg>;
        const IconStat = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20V10"></path><path d="M18 20V4"></path><path d="M6 20v-4"></path></svg>;

        // --- EASING FUNCTIONS FOR ANIMATION ---
        const easeOutExpo = (x) => x === 1 ? 1 : 1 - Math.pow(2, -10 * x);
        const easeOutBack = (x) => { const c1 = 1.70158; const c3 = c1 + 1; return 1 + c3 * Math.pow(x - 1, 3) + c1 * Math.pow(x - 1, 2); };
        const easeOutQuint = (x) => 1 - Math.pow(1 - x, 5);

        // --- GLOBAL CANVAS HELPERS ---
        // Added maxWidth parameter to automatically scale down ultra-long texts!
        const drawText = (ctx, text, x, y, fs, color, align, fw, alpha = 1, shadow = true, isExport = false, maxWidth = null) => { 
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.font = `${fw} ${fs}px "Hind Siliguri", sans-serif`; 
            ctx.textAlign = align; 
            ctx.textBaseline = 'middle';
            
            if (shadow) {
                if (isExport) {
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.9)'; // Darkened for better contrast
                    ctx.shadowBlur = 15;
                    ctx.shadowOffsetX = 3;
                    ctx.shadowOffsetY = 5;
                } else {
                    ctx.fillStyle = 'rgba(0,0,0,0.8)';
                    if (maxWidth) ctx.fillText(text, x + 3, y + 3, maxWidth);
                    else ctx.fillText(text, x + 3, y + 3);
                }
            }
            
            ctx.fillStyle = color; 
            if (maxWidth) ctx.fillText(text, x, y, maxWidth);
            else ctx.fillText(text, x, y); 
            ctx.restore();
        };

        // Professional TV-style angled background panel
        const drawAngledPanel = (ctx, x, y, w, h, skew, color, alpha = 1, shadow = false, isExport = false) => {
            ctx.save();
            ctx.globalAlpha = alpha;
            if (shadow && isExport) {
                ctx.shadowColor = 'rgba(0,0,0,0.5)';
                ctx.shadowBlur = 20;
                ctx.shadowOffsetY = 10;
            }
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x + skew, y);
            ctx.lineTo(x + w + skew, y);
            ctx.lineTo(x + w, y + h);
            ctx.lineTo(x, y + h);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        };

        const drawCover = (ctx, img, x, y, w, h, scale = 1, panX = 0, panY = 0, alpha = 1) => {
            if(!img) return;
            ctx.save();
            ctx.globalAlpha = alpha;
            
            const cx = x + w/2;
            const cy = y + h/2;
            ctx.translate(cx + panX, cy + panY);
            ctx.scale(scale, scale);
            ctx.translate(-cx, -cy);

            const r = img.width/img.height, tr = w/h;
            let sx, sy, sw, sh;
            if (r > tr) { sh = img.height; sw = img.height * tr; sy = 0; sx = (img.width - sw) / 2; }
            else { sw = img.width; sh = img.width / tr; sx = 0; sy = (img.height - sh) / 2; }
            
            ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
            ctx.restore();
        };

        function App() {
            const canvasRef = useRef(null);
            
            const [appMode, setAppMode] = useState('match_reel'); 
            const [bgImage, setBgImage] = useState(null);
            
            const [isPlaying, setIsPlaying] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            const [progress, setProgress] = useState(0); 
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [wrappedLines, setWrappedLines] = useState([]);
            
            const animationRef = useRef(null);
            const startTimeRef = useRef(0);
            const pausedTimeRef = useRef(0);
            
            const [userId, setUserId] = useState('');
            const [points, setPoints] = useState(50); 

            const [formData, setFormData] = useState({
                badgeText: 'ProReels_Bot',
                primaryColor: '#e11d48', 
                secondaryColor: '#881337', 
                bgOpacity: 0.85,
                
                headline: 'ব্রেকিং নিউজ',
                quoteText: 'আমাদের লক্ষ্য এখন বিশ্বকাপ জয় করা। কোনো দলকেই আমরা ছোট করে দেখছি না।',
                quoteAuthor: 'নাজমুল হোসেন শান্ত, অধিনায়ক',

                team1: 'বাংলাদেশ', team1Color: '#16a34a', team1Score: '১৮৪/৭',
                team2: 'ভারত', team2Color: '#2563eb', team2Score: '১৮০/৬',
                result: 'বাংলাদেশ ৪ রানে জয়ী',
                
                playerName: 'সাকিব আল হাসান',
                playerStatMain: '৮২', playerStatSub: 'রান (৪৫ বল)',
                playerRole: 'ম্যান অফ দ্যা ম্যাচ'
            });

            useEffect(() => {
                let storedId = localStorage.getItem('poster_user_id');
                if (!storedId) { storedId = 'u_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('poster_user_id', storedId); }
                setUserId(storedId); 
            }, []);

            // Pre-calculate precise text wrapping for News Quotes to prevent lag
            useEffect(() => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.font = "bold 55px 'Hind Siliguri', sans-serif"; 
                const words = formData.quoteText.split(' ');
                let currentLine = "";
                const lines = [];
                for (let i = 0; i < words.length; i++) {
                    const word = words[i];
                    if (ctx.measureText(currentLine + " " + word).width < 1080 * 0.75) {
                        currentLine += (currentLine === "" ? "" : " ") + word;
                    } else {
                        lines.push(currentLine); currentLine = word;
                    }
                }
                if(currentLine) lines.push(currentLine);
                setWrappedLines(lines);
            }, [formData.quoteText]);

            // --- THE HIGH-FIDELITY ANIMATION RENDERER ---
            const renderFrame = useCallback((ctx, time, W, H, isExport = false) => {
                ctx.fillStyle = '#050505'; 
                ctx.fillRect(0, 0, W, H);

                // Cinematic Ken Burns
                const kenBurnsScale = 1.05 + (time * 0.1); 
                const panX = Math.sin(time * Math.PI) * 20; 
                const panY = -(time * 30); 
                
                if (bgImage) drawCover(ctx, bgImage, 0, 0, W, H, kenBurnsScale, panX, panY, 1);

                // Cinematic Overlays
                ctx.save();
                const vignette = ctx.createRadialGradient(W/2, H/2, H*0.3, W/2, H/2, H*0.8);
                vignette.addColorStop(0, 'rgba(0,0,0,0)');
                vignette.addColorStop(1, 'rgba(0,0,0,0.8)');
                ctx.fillStyle = vignette; ctx.fillRect(0, 0, W, H);

                ctx.globalAlpha = formData.bgOpacity; 
                const gradient = ctx.createLinearGradient(0, H * 0.35, 0, H);
                gradient.addColorStop(0, 'rgba(0,0,0,0)'); 
                gradient.addColorStop(0.5, formData.primaryColor);
                gradient.addColorStop(1, '#000000'); 
                ctx.fillStyle = gradient; ctx.fillRect(0, 0, W, H);
                ctx.restore();

                // Live Indicator
                ctx.save();
                const liveAlpha = Math.sin(time * Math.PI * 8) * 0.5 + 0.5;
                ctx.fillStyle = `rgba(239, 68, 68, ${liveAlpha})`; 
                ctx.beginPath(); ctx.arc(W - 80, 80, 15, 0, Math.PI*2); ctx.fill();
                drawText(ctx, "LIVE", W - 110, 80, 35, '#fff', 'right', 'bold', 1, true, isExport);
                ctx.restore();

                // ---------------------------------------------------------------------------------
                // NEWS REEL MODE
                // ---------------------------------------------------------------------------------
                if (appMode === 'news_reel') {
                    const inAnim = easeOutQuint(Math.min(Math.max((time - 0.05) * 5, 0), 1)); 
                    const cy = H * 0.55; 

                    const boxHeight = (wrappedLines.length * 90) + 160;
                    const boxY = cy - boxHeight/2 + ((1 - inAnim) * 100);
                    
                    ctx.save();
                    ctx.globalAlpha = inAnim;
                    
                    // Glass backdrop
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                    if(ctx.roundRect) ctx.roundRect(W*0.1, boxY, W*0.8, boxHeight, 30); else ctx.fillRect(W*0.1, boxY, W*0.8, boxHeight);
                    ctx.fill();
                    
                    // Decorative Quote Mark inside glass
                    ctx.globalAlpha = inAnim * 0.15;
                    ctx.font = 'bold 300px serif';
                    ctx.fillStyle = formData.primaryColor;
                    ctx.fillText('"', W*0.1 + 80, boxY + 150);

                    // Glowing Left Border accent
                    ctx.globalAlpha = inAnim;
                    ctx.fillStyle = formData.primaryColor;
                    if(ctx.roundRect) ctx.roundRect(W*0.1, boxY, 15, boxHeight, {tl: 30, bl: 30, tr: 0, br: 0}); else ctx.fillRect(W*0.1, boxY, 15, boxHeight);
                    if (isExport) { ctx.shadowColor = formData.primaryColor; ctx.shadowBlur = 20; }
                    ctx.fill();
                    ctx.restore();

                    // Breaking News Badge 
                    const badgeWidth = ctx.measureText(formData.headline).width + 80;
                    drawAngledPanel(ctx, W*0.1 + 40, boxY - 30, badgeWidth, 60, 20, '#ef4444', inAnim, true, isExport);
                    drawText(ctx, formData.headline, W*0.1 + 40 + badgeWidth/2 + 10, boxY, 32, '#fff', 'center', 'bold', inAnim, true, isExport);

                    // Quote Text
                    wrappedLines.forEach((line, i) => { 
                        const lineProgress = Math.min(Math.max((time - 0.15 - (i * 0.05)) * 5, 0), 1);
                        const lineEased = easeOutExpo(lineProgress);
                        const lineY = boxY + 100 + (i * 90);
                        
                        ctx.save();
                        // Increased clipping height to protect tall Bengali fonts from getting sliced
                        ctx.beginPath(); ctx.rect(0, lineY - 60, W, 120); ctx.clip(); 
                        const driftY = lineY + ((1 - lineEased) * 50);
                        drawText(ctx, line, W*0.1 + 50, driftY, 55, '#fff', 'left', 'bold', lineProgress, true, isExport);
                        ctx.restore();
                    });

                    // Author Line
                    const authorIn = easeOutBack(Math.min(Math.max((time - 0.3) * 5, 0), 1)); 
                    const ay = boxY + boxHeight - 50;
                    ctx.save();
                    ctx.globalAlpha = Math.min(authorIn, 1);
                    drawText(ctx, "— " + formData.quoteAuthor, W*0.1 + 50, ay, 38, '#cbd5e1', 'left', 'bold', 1, true, isExport);
                    ctx.restore();

                // ---------------------------------------------------------------------------------
                // MATCH REEL MODE (FIXED & WIDENED)
                // ---------------------------------------------------------------------------------
                } else if (appMode === 'match_reel') {
                    const t1In = easeOutBack(Math.min(Math.max((time - 0.05) * 5, 0), 1));
                    const t2In = easeOutBack(Math.min(Math.max((time - 0.1) * 5, 0), 1));
                    const vsPop = easeOutBack(Math.min(Math.max((time - 0.2) * 5, 0), 1));
                    const resIn = easeOutQuint(Math.min(Math.max((time - 0.3) * 4, 0), 1));

                    const cy = H * 0.55;
                    const pWidth = 760; // Much wider for professional broadcast feel
                    const pHeight = 170;
                    const skewAmount = 45; // Sleek angled cut

                    // --- Left Team (Top Panel) ---
                    // It slides perfectly from outside the screen to exactly W/2 center
                    const targetLx = (W/2) - (pWidth/2);
                    const startLx = -pWidth - skewAmount;
                    const lx = startLx + (targetLx - startLx) * t1In;
                    
                    drawAngledPanel(ctx, lx, cy - pHeight - 20, pWidth, pHeight, skewAmount, formData.team1Color, t1In, true, isExport);
                    
                    // Text geometrically aligns WITH the sliding panel
                    const t1CenterX = lx + (pWidth/2) + (skewAmount/2);
                    // Use maxWidth = pWidth - 100 to ensure huge names like "South Africa" never bleed out!
                    drawText(ctx, formData.team1, t1CenterX, cy - pHeight + 25, 55, '#fff', 'center', 'bold', t1In, true, isExport, pWidth - 100);
                    drawText(ctx, formData.team1Score, t1CenterX, cy - pHeight + 100, 95, '#fff', 'center', 'bold', t1In, true, isExport, pWidth - 100);

                    // --- Right Team (Bottom Panel) ---
                    const targetRx = (W/2) - (pWidth/2);
                    const startRx = W + skewAmount;
                    const rx = startRx + (targetRx - startRx) * t2In;
                    
                    drawAngledPanel(ctx, rx, cy + 20, pWidth, pHeight, skewAmount, formData.team2Color, t2In, true, isExport);
                    
                    const t2CenterX = rx + (pWidth/2) + (skewAmount/2);
                    drawText(ctx, formData.team2, t2CenterX, cy + 65, 55, '#fff', 'center', 'bold', t2In, true, isExport, pWidth - 100);
                    drawText(ctx, formData.team2Score, t2CenterX, cy + 140, 95, '#fff', 'center', 'bold', t2In, true, isExport, pWidth - 100);

                    // --- VS Circle Overlap ---
                    ctx.save();
                    ctx.globalAlpha = Math.min(vsPop, 1);
                    ctx.translate(W/2, cy); ctx.scale(vsPop, vsPop);
                    ctx.beginPath(); ctx.arc(0, 0, 55, 0, Math.PI*2); 
                    ctx.fillStyle = '#0f172a'; ctx.fill(); 
                    ctx.lineWidth = 5; ctx.strokeStyle = '#fff'; ctx.stroke();
                    drawText(ctx, "VS", 0, 0, 40, '#fff', 'center', 'bold', 1, false, isExport);
                    ctx.restore();

                    // --- Result Box (Bottom) ---
                    const ry = cy + 300 + ((1 - resIn) * 100); // Shifted down for breathing room
                    const rawW = ctx.measureText(formData.result).width + 160; // Extra padding
                    const resW = Math.min(rawW, W - 80); // Ensure it doesn't touch screen edges
                    const resSkew = -35;
                    
                    // Dark solid panel for maximum contrast against ANY background image
                    drawAngledPanel(ctx, W/2 - resW/2, ry - 45, resW, 90, resSkew, 'rgba(0,0,0,0.85)', resIn, true, isExport);
                    // Colored accent line at the bottom using Primary Color
                    drawAngledPanel(ctx, W/2 - resW/2, ry + 35, resW, 10, resSkew, formData.primaryColor, resIn, false, isExport);
                    
                    const resCenterX = (W/2) + (resSkew/2);
                    // Force white text on the dark background so it is always 100% visible
                    drawText(ctx, formData.result, resCenterX, ry - 5, 48, '#ffffff', 'center', 'bold', resIn, true, isExport, resW - 60);

                // ---------------------------------------------------------------------------------
                // STAT REEL MODE
                // ---------------------------------------------------------------------------------
                } else if (appMode === 'stat_reel') {
                    const pop1 = easeOutBack(Math.min(Math.max((time - 0.1) * 5, 0), 1));
                    const slideUp = easeOutQuint(Math.min(Math.max((time - 0.2) * 4, 0), 1));
                    const cy = H * 0.55;

                    // High Tech Box for Stat
                    ctx.save();
                    ctx.globalAlpha = Math.min(pop1, 1);
                    ctx.translate(W/2, cy - 100);
                    ctx.scale(pop1, pop1);
                    
                    if (isExport) { ctx.shadowColor = formData.team1Color; ctx.shadowBlur = 40; }
                    drawAngledPanel(ctx, -180, -180, 360, 360, 0, 'rgba(0,0,0,0.6)', 1, false, false);
                    ctx.lineWidth = 6; ctx.strokeStyle = formData.team1Color; ctx.strokeRect(-180, -180, 360, 360);
                    
                    drawText(ctx, formData.playerStatMain, 0, -20, 180, '#fff', 'center', 'bold', 1, true, isExport, 320);
                    drawAngledPanel(ctx, -120, 60, 240, 60, 20, formData.team1Color, 1, false, false);
                    drawText(ctx, formData.playerStatSub, 0, 90, 35, '#fff', 'center', 'bold', 1, false, false, 200);
                    ctx.restore();

                    // Player Name & Role
                    const py = cy + 200 + ((1 - slideUp) * 100);
                    ctx.save();
                    ctx.globalAlpha = slideUp;
                    drawText(ctx, formData.playerName, W/2, py, 80, '#fff', 'center', 'bold', 1, true, isExport, W - 100);
                    drawText(ctx, formData.playerRole, W/2, py + 70, 40, formData.team1Color, 'center', 'bold', 1, true, isExport, W - 100);
                    ctx.restore();
                }

                // ---------------------------------------------------------------------------------
                // GLOBAL FOOTER / WATERMARK
                // ---------------------------------------------------------------------------------
                const globalFade = Math.min(time * 5, 1);
                ctx.save();
                ctx.globalAlpha = globalFade;
                const footerY = H - 100;
                
                drawAngledPanel(ctx, W/2 - 200, footerY - 35, 400, 70, 20, 'rgba(0,0,0,0.6)', 1, false, false);
                ctx.beginPath(); ctx.arc(W/2 - 140, footerY, 20, 0, Math.PI * 2); 
                ctx.fillStyle = '#1877F2'; ctx.fill();
                drawText(ctx, "f", W/2 - 140, footerY, 28, "#fff", "center", "bold", 1, false, isExport);
                drawText(ctx, formData.badgeText, W/2 - 100, footerY, 30, '#fff', 'left', 'bold', 1, true, isExport, 260);
                ctx.restore();

            }, [bgImage, formData, appMode, wrappedLines]);

            // --- ANIMATION ENGINE ---
            const tick = useCallback((timestamp) => {
                if (!canvasRef.current) return;
                if (!startTimeRef.current) startTimeRef.current = timestamp - pausedTimeRef.current;
                const elapsedMs = timestamp - startTimeRef.current;
                const totalDurationMs = VIDEO_DURATION_SEC * 1000;
                let currentProgress = elapsedMs / totalDurationMs;
                
                if (currentProgress >= 1) {
                    currentProgress = 1; setIsPlaying(false); pausedTimeRef.current = 0; 
                    renderFrame(canvasRef.current.getContext('2d'), 1, 1080, 1920, false);
                    setProgress(1); return; 
                }

                setProgress(currentProgress);
                renderFrame(canvasRef.current.getContext('2d'), currentProgress, 1080, 1920, false);
                if (isPlaying) animationRef.current = requestAnimationFrame(tick);
            }, [isPlaying, renderFrame]);

            useEffect(() => {
                if (isPlaying) animationRef.current = requestAnimationFrame(tick);
                else {
                    if (animationRef.current) cancelAnimationFrame(animationRef.current);
                    pausedTimeRef.current = progress * (VIDEO_DURATION_SEC * 1000);
                    startTimeRef.current = 0;
                }
                return () => { if (animationRef.current) cancelAnimationFrame(animationRef.current); };
            }, [isPlaying, tick, progress]);

            useEffect(() => {
                if (!isPlaying && canvasRef.current) renderFrame(canvasRef.current.getContext('2d'), progress, 1080, 1920, false);
            }, [formData, appMode, bgImage, progress, isPlaying, renderFrame]);

            // --- EVENT HANDLERS ---
            const togglePlay = () => {
                if (progress >= 1) { setProgress(0); pausedTimeRef.current = 0; }
                if (!isPlaying && window.innerWidth < 1024) setIsFullscreen(true); 
                setIsPlaying(!isPlaying);
            };

            const handleGenerateVideo = async () => {
                if (isGenerating || !canvasRef.current || !bgImage) return;
                if (points < DOWNLOAD_COST) return alert(`Need ${DOWNLOAD_COST} points.`);

                setIsGenerating(true); setIsPlaying(false); setProgress(0);
                
                const canvas = canvasRef.current; const ctx = canvas.getContext('2d');
                const stream = canvas.captureStream(FPS);
                const mimeType = MediaRecorder.isTypeSupported('video/webm; codecs=vp9') ? 'video/webm; codecs=vp9' : 'video/mp4';
                const recorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: 8000000 }); 
                const chunks = [];
                
                recorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.style.display = 'none'; a.href = url;
                    a.download = `reel-${Date.now()}.${mimeType.includes('mp4') ? 'mp4' : 'webm'}`;
                    document.body.appendChild(a); a.click();
                    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); setIsGenerating(false); setPoints(p => p - DOWNLOAD_COST); }, 100);
                };

                recorder.start();

                let frameCount = 0; const totalFrames = VIDEO_DURATION_SEC * FPS;
                const recordFrame = () => {
                    const currentProg = frameCount / totalFrames;
                    setProgress(currentProg);
                    renderFrame(ctx, currentProg, 1080, 1920, true); // true = High Quality Shadows Active!
                    frameCount++;
                    if (frameCount <= totalFrames) setTimeout(recordFrame, 1000/FPS); 
                    else recorder.stop();
                };
                recordFrame();
            };

            const handleChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
                if(progress === 1) setProgress(0); 
            };

            const InputField = ({ label, name, value, type="text", placeholder }) => (
                <div className="mb-3">
                    <label className="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 ml-1">{label}</label>
                    <input type={type} name={name} value={value} onChange={handleChange} placeholder={placeholder} 
                        className="w-full px-4 py-2.5 bg-slate-950 border border-slate-800 rounded-xl text-sm text-white focus:border-blue-500 focus:bg-slate-900 transition-all outline-none" />
                </div>
            );

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-slate-950 font-sans">
                    
                    {/* LEFT PANEL: EDITOR */}
                    <div className="order-2 lg:order-1 w-full lg:w-[460px] bg-[#0b1121] border-r-0 lg:border-r border-slate-800 flex flex-col h-auto lg:h-screen overflow-visible lg:overflow-y-auto custom-scrollbar shadow-[20px_0_50px_rgba(0,0,0,0.5)] z-10 relative pb-10 lg:pb-0">
                        
                        <header className="px-5 py-4 border-b border-slate-800 bg-[#0b1121]/90 static lg:sticky top-0 backdrop-blur-xl z-20 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-tr from-blue-600 to-indigo-500 p-2.5 rounded-xl shadow-lg shadow-blue-500/20">
                                    <IconVideo className="text-white w-5 h-5" />
                                </div>
                                <div>
                                    <h1 className="text-xl font-black tracking-tight leading-tight text-white">Reel Bot <span className="text-blue-500">PRO</span></h1>
                                    <p className="text-[9px] text-slate-400 font-bold uppercase tracking-[0.2em]">Cinematic Studio</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-1.5 bg-slate-900 px-3 py-1.5 rounded-lg border border-slate-800 shadow-inner">
                                <IconCoin /> <span className="text-sm font-bold text-yellow-500">{points}</span>
                            </div>
                        </header>

                        <div className="p-5 space-y-6">
                            
                            {/* Templates Card */}
                            <div className="bg-slate-900 border border-slate-800 rounded-2xl p-4">
                                <label className="block text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">Select Template</label>
                                <div className="grid grid-cols-3 gap-2">
                                    {[
                                        { id: 'news_reel', label: 'News', icon: <IconNews/> },
                                        { id: 'match_reel', label: 'Match', icon: <IconMatch/> },
                                        { id: 'stat_reel', label: 'Stats', icon: <IconStat/> }
                                    ].map(tmpl => (
                                        <button key={tmpl.id} onClick={() => { setAppMode(tmpl.id); setProgress(0); setIsPlaying(false); }} 
                                            className={`flex flex-col items-center justify-center gap-2 py-4 rounded-xl text-xs font-bold transition-all border ${appMode === tmpl.id ? 'bg-blue-600 border-blue-500 text-white shadow-lg shadow-blue-600/30' : 'bg-slate-950 border-slate-800 text-slate-400 hover:bg-slate-800'}`}>
                                            {tmpl.icon}
                                            <span>{tmpl.label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Background Card */}
                            <div className="bg-slate-900 border border-slate-800 rounded-2xl p-4">
                                <label className="block text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">Background Media</label>
                                <div className="relative group w-full h-32 bg-slate-950 border-2 border-dashed border-slate-700 hover:border-blue-500 rounded-xl flex flex-col items-center justify-center transition-all cursor-pointer overflow-hidden">
                                    <input type="file" accept="image/*" onChange={(e) => { const f = e.target.files[0]; if(f){ const r = new FileReader(); r.onload = (ev) => { const img = new Image(); img.onload = () => { setBgImage(img); setProgress(0); }; img.src = ev.target.result; }; r.readAsDataURL(f); } }} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                    {bgImage && <div className="absolute inset-0 opacity-30 bg-cover bg-center" style={{backgroundImage: `url(${bgImage.src})`}}></div>}
                                    <div className="bg-slate-800 p-3 rounded-full mb-2 group-hover:scale-110 transition-transform"><IconUpload className="text-blue-400 w-5 h-5" /></div>
                                    <span className="text-xs font-bold text-slate-300 z-0 relative">{bgImage ? 'Tap to Replace' : 'Upload 9:16 Photo'}</span>
                                </div>
                            </div>

                            {/* Content Editor Card */}
                            <div className="bg-slate-900 border border-slate-800 rounded-2xl p-4 shadow-xl">
                                <label className="block text-xs font-bold text-slate-400 uppercase mb-4 pb-2 border-b border-slate-800">Content Editor</label>
                                
                                <div className="flex gap-3 mb-4">
                                    <div className="flex-1">
                                        <label className="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 ml-1">Primary Color</label>
                                        <input type="color" name="primaryColor" value={formData.primaryColor} onChange={handleChange} className="h-10 w-full rounded-xl cursor-pointer bg-slate-950 border border-slate-800" />
                                    </div>
                                    <div className="flex-1">
                                        <label className="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 ml-1">Secondary Color</label>
                                        <input type="color" name="secondaryColor" value={formData.secondaryColor} onChange={handleChange} className="h-10 w-full rounded-xl cursor-pointer bg-slate-950 border border-slate-800" />
                                    </div>
                                </div>

                                {appMode === 'news_reel' && (
                                    <div className="space-y-1">
                                        <InputField label="Headline Badge" name="headline" value={formData.headline} />
                                        <div className="mb-3">
                                            <label className="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 ml-1">News / Quote Body</label>
                                            <textarea name="quoteText" value={formData.quoteText} onChange={handleChange} rows="4" className="w-full px-4 py-3 bg-slate-950 border border-slate-800 rounded-xl text-sm text-white focus:border-blue-500 focus:bg-slate-900 transition-all outline-none resize-none"></textarea>
                                        </div>
                                        <InputField label="Source / Author" name="quoteAuthor" value={formData.quoteAuthor} />
                                    </div>
                                )}

                                {appMode === 'match_reel' && (
                                    <div className="space-y-4">
                                        <div className="p-4 border border-slate-800 rounded-xl bg-slate-950/50">
                                            <div className="flex justify-between items-center mb-3"><span className="text-xs font-bold text-slate-300">Home Team (Top)</span><input type="color" name="team1Color" value={formData.team1Color} onChange={handleChange} className="w-6 h-6 rounded bg-transparent border-0 cursor-pointer"/></div>
                                            <div className="flex gap-2">
                                                <input type="text" name="team1" value={formData.team1} onChange={handleChange} className="flex-1 px-3 py-2 bg-slate-900 border border-slate-800 rounded-lg text-sm text-white outline-none" placeholder="Name" />
                                                <input type="text" name="team1Score" value={formData.team1Score} onChange={handleChange} className="w-24 px-3 py-2 bg-slate-900 border border-slate-800 rounded-lg text-sm text-white outline-none font-bold text-center" placeholder="Score" />
                                            </div>
                                        </div>
                                        <div className="p-4 border border-slate-800 rounded-xl bg-slate-950/50">
                                            <div className="flex justify-between items-center mb-3"><span className="text-xs font-bold text-slate-300">Away Team (Bottom)</span><input type="color" name="team2Color" value={formData.team2Color} onChange={handleChange} className="w-6 h-6 rounded bg-transparent border-0 cursor-pointer"/></div>
                                            <div className="flex gap-2">
                                                <input type="text" name="team2" value={formData.team2} onChange={handleChange} className="flex-1 px-3 py-2 bg-slate-900 border border-slate-800 rounded-lg text-sm text-white outline-none" placeholder="Name" />
                                                <input type="text" name="team2Score" value={formData.team2Score} onChange={handleChange} className="w-24 px-3 py-2 bg-slate-900 border border-slate-800 rounded-lg text-sm text-white outline-none font-bold text-center" placeholder="Score" />
                                            </div>
                                        </div>
                                        <InputField label="Match Result" name="result" value={formData.result} />
                                    </div>
                                )}

                                {appMode === 'stat_reel' && (
                                    <div className="space-y-1">
                                        <InputField label="Player Name" name="playerName" value={formData.playerName} />
                                        <div className="flex gap-3 mb-3">
                                            <div className="flex-1">
                                                <label className="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 ml-1">Main Stat</label>
                                                <input type="text" name="playerStatMain" value={formData.playerStatMain} onChange={handleChange} className="w-full px-4 py-2 bg-slate-950 border border-slate-800 rounded-xl text-lg text-white outline-none font-black text-center" />
                                            </div>
                                            <div className="flex-1">
                                                <label className="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 ml-1">Sub Stat</label>
                                                <input type="text" name="playerStatSub" value={formData.playerStatSub} onChange={handleChange} className="w-full px-4 py-2 bg-slate-950 border border-slate-800 rounded-xl text-sm text-white outline-none text-center" />
                                            </div>
                                        </div>
                                        <InputField label="Tagline / Role" name="playerRole" value={formData.playerRole} />
                                    </div>
                                )}
                            </div>

                            {/* Footer Settings */}
                            <div className="bg-slate-900 border border-slate-800 rounded-2xl p-4">
                                <InputField label="Watermark Handle" name="badgeText" value={formData.badgeText} placeholder="@yourpage" />
                            </div>
                        </div>
                    </div>

                    {/* RIGHT PANEL: VIDEO PREVIEW & RENDER */}
                    <div className="order-1 lg:order-2 w-full lg:flex-1 flex flex-col items-center justify-center p-4 sm:p-6 lg:p-10 bg-[#020617] sticky top-0 z-40 lg:relative lg:h-screen lg:overflow-y-auto border-b lg:border-b-0 border-slate-800 backdrop-blur-3xl">
                        
                        <div className="flex flex-row lg:flex-col items-center justify-center gap-5 lg:gap-8 w-full max-w-md lg:max-w-none mx-auto">
                            
                            {/* The Phone Outline / Canvas Container */}
                            <div className={`transition-all duration-300 ${
                                isFullscreen 
                                ? 'fixed inset-0 z-[100] w-full h-full bg-black/95 backdrop-blur-3xl flex flex-col items-center justify-center' 
                                : 'w-[120px] sm:w-[150px] lg:w-full lg:max-w-[360px] flex-shrink-0 relative shadow-[0_30px_60px_rgba(0,0,0,0.8)] rounded-[1rem] lg:rounded-[2.5rem] overflow-hidden border-4 lg:border-[8px] border-slate-800 bg-black aspect-[9/16]'
                            }`}>
                                {isFullscreen && (
                                    <button onClick={() => { setIsFullscreen(false); setIsPlaying(false); }} className="absolute top-6 right-6 z-[110] bg-white/10 hover:bg-white/20 text-white p-3 rounded-full backdrop-blur-md transition-colors">
                                        <IconClose />
                                    </button>
                                )}
                                <canvas 
                                    ref={canvasRef} 
                                    width="1080" 
                                    height="1920" 
                                    className={isFullscreen ? "max-h-[85vh] max-w-full aspect-[9/16] object-contain shadow-2xl rounded-2xl border-4 border-slate-800" : "w-full h-full object-cover"}
                                ></canvas>
                                
                                {isGenerating && (
                                    <div className="absolute inset-0 bg-slate-900/90 backdrop-blur-md flex flex-col items-center justify-center z-50">
                                        <div className="loader mb-3 lg:mb-5"></div>
                                        <p className="text-white font-black tracking-wide animate-pulse text-xs lg:text-lg text-center leading-tight">ENCODING<br/>REEL</p>
                                        <div className="w-16 lg:w-32 h-1.5 lg:h-2 bg-slate-800 rounded-full mt-4 overflow-hidden">
                                            <div className="h-full bg-blue-500 rounded-full transition-all duration-300" style={{width: `${progress * 100}%`}}></div>
                                        </div>
                                        <p className="text-slate-400 font-mono text-[8px] lg:text-xs mt-2">{Math.round(progress * 100)}%</p>
                                    </div>
                                )}
                            </div>

                            {/* Player Controls */}
                            <div className="flex-1 lg:w-full lg:max-w-[360px] bg-slate-900/80 border border-slate-800 rounded-2xl lg:rounded-3xl p-4 lg:p-5 shadow-2xl backdrop-blur-xl">
                                <div className="flex items-center gap-3 lg:gap-4 mb-4 lg:mb-5">
                                    <button onClick={togglePlay} disabled={isGenerating} className="bg-white text-slate-900 hover:bg-slate-200 p-3 lg:p-4 rounded-full flex-shrink-0 transition-transform active:scale-95 disabled:opacity-50 shadow-lg">
                                        {isPlaying ? <IconPause /> : <IconPlay />}
                                    </button>
                                    
                                    <div className="flex-1 flex flex-col justify-center">
                                        <div className="flex justify-between text-[10px] text-slate-400 font-bold mb-1.5 font-mono">
                                            <span>0:0{(progress * VIDEO_DURATION_SEC).toFixed(1)}</span>
                                            <span>0:0{VIDEO_DURATION_SEC}.0</span>
                                        </div>
                                        <input type="range" className="timeline" min="0" max="1" step="0.001" value={progress} onChange={(e) => { const v = parseFloat(e.target.value); setProgress(v); pausedTimeRef.current = v * VIDEO_DURATION_SEC * 1000; if(!isPlaying) renderFrame(canvasRef.current.getContext('2d'), v, 1080, 1920, false); }} disabled={isGenerating} />
                                    </div>
                                </div>

                                <button 
                                    onClick={handleGenerateVideo} 
                                    disabled={isGenerating || !bgImage}
                                    className={`w-full py-3 lg:py-4 rounded-xl lg:rounded-2xl font-black text-sm tracking-widest uppercase transition-all flex justify-center items-center gap-2 ${
                                        isGenerating || !bgImage ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'export-btn-ready text-white'
                                    }`}
                                >
                                    {isGenerating ? 'Rendering...' : `Export Reel (${DOWNLOAD_COST} Pts)`}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
