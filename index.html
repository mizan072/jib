<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sports Poster Bot</title>
    
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Ad Script (Fixed Protocol) -->
    <script src='https://libtl.com/sdk.js' data-zone='9743120' data-sdk='show_9743120'></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Error Suppression & Polyfill -->
    <script>
        // Suppress specific CloudStorage error log from Telegram library
        const originalError = console.error;
        console.error = function(...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('CloudStorage is not supported')) {
                return; // Ignore this specific error
            }
            originalError.apply(console, args);
        };

        // Simple Polyfill for CloudStorage if missing
        window.addEventListener('DOMContentLoaded', () => {
            if (window.Telegram && window.Telegram.WebApp && !window.Telegram.WebApp.CloudStorage) {
                window.Telegram.WebApp.CloudStorage = {
                    getItem: (k, cb) => cb && cb(null, localStorage.getItem(k)),
                    setItem: (k, v, cb) => { localStorage.setItem(k, v); cb && cb(null, true); },
                    removeItem: (k, cb) => { localStorage.removeItem(k); cb && cb(null, true); }
                };
            }
        });
    </script>

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; touch-action: pan-y; background-color: var(--tg-theme-bg-color, #f8fafc); color: var(--tg-theme-text-color, #0f172a); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .canvas-container { touch-action: none; }
        
        /* Modal Animation */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-backdrop { animation: fadeIn 0.2s ease-out; }
        .modal-content { animation: scaleIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>;
        const IconRefresh = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>;
        const IconSwap = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m7 2 10 10-10 10"></path><path d="M17 12H3"></path></svg>;
        const IconMove = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>;
        const IconZoomIn = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>;
        const IconEye = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>;
        const IconCalendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const IconUser = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const IconQuote = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/></svg>;

        function App() {
            const canvasRef = useRef(null);
            
            // App Mode: 'scorecard', 'schedule', 'player', 'news'
            const [appMode, setAppMode] = useState('scorecard');
            const [activeTab, setActiveTab] = useState('match');
            const [bgImage, setBgImage] = useState(null);
            
            // Ad State
            const [showAdModal, setShowAdModal] = useState(false);
            const [adsWatched, setAdsWatched] = useState(0);
            const [isLoadingAd, setIsLoadingAd] = useState(false);
            const [isDownloadReady, setIsDownloadReady] = useState(false);
            
            // Image Transform State
            const [imgPos, setImgPos] = useState({ x: 0, y: 0, scale: 1 });
            const gestureStart = useRef({ x: 0, y: 0, dist: 0, scale: 1, imgX: 0, imgY: 0, mode: null });

            // Default Data
            const [formData, setFormData] = useState({
                // Common
                badgeText: 'proscorecard_bot', 
                title: 'আইসিসি টি-টোয়েন্টি বিশ্বকাপ',
                footerHandle: 'এই রকম পোস্টার তৈরি করুন এই টেলিগ্রাম বট দিয়েঃ  @proscorecard_bot',
                primaryColor: '#990000',
                secondaryColor: '#4a0000',
                bgOpacity: 0.9,
                
                // Scorecard & Schedule
                team1: 'ইংল্যান্ড',
                team1Color: '#ffd700',
                team2: 'নেপাল',
                team2Color: '#ffd700',
                team1Score: '১৮৪/৭',
                team1Overs: '(২০ ওভার)',
                team2Score: '১৮০/৬',
                team2Overs: '(২০ ওভার)',
                result: 'নেপালকে ৪ রানে হারিয়েছে ইংল্যান্ড',
                resultColor: '#ffd700',
                matchDate: '২০ অক্টোবর, ২০২৫',
                matchTime: 'দুপুর ২:০০টা',
                matchVenue: 'শেরে বাংলা স্টেডিয়াম',

                // Player Stats (Cleaned up: Only Run & Ball)
                playerName: 'সাকিব আল হাসান',
                playerStatMain: '৮২',
                playerStatSub: 'রান (৪৫ বল)',

                // News/Quote
                quoteText: 'আমাদের লক্ষ্য এখন বিশ্বকাপ জয় করা। আমরা সেরাটা দিয়েই চেষ্টা করবো।',
                quoteAuthor: 'নাজমুল হোসেন শান্ত, অধিনায়ক'
            });

            // Load Default Image
            useEffect(() => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = "https://images.unsplash.com/photo-1531415074968-036ba1b575da?q=80&w=1080&auto=format&fit=crop";
                img.onload = () => {
                    setBgImage(img);
                    const W = 1080, H = 1200;
                    const scale = Math.max(W / img.width, H / img.height);
                    setImgPos({ x: (W - img.width * scale) / 2, y: (H - img.height * scale) / 2, scale });
                };
            }, []);

            // Initialize Telegram Mini App
            useEffect(() => {
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.ready();
                    if (window.Telegram.WebApp.expand) window.Telegram.WebApp.expand(); 
                }
            }, []);

            // Handle Image Upload & Auto-Fit
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            setBgImage(img);
                            const W = 1080;
                            const H = 1200;
                            const scale = Math.max(W / img.width, H / img.height);
                            const x = (W - img.width * scale) / 2;
                            const y = (H - img.height * scale) / 2;
                            setImgPos({ x, y, scale });
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const resetImage = () => {
                if(bgImage) {
                    const W = 1080;
                    const H = 1200;
                    const scale = Math.max(W / bgImage.width, H / bgImage.height);
                    const x = (W - bgImage.width * scale) / 2;
                    const y = (H - bgImage.height * scale) / 2;
                    setImgPos({ x, y, scale });
                }
            };

            // --- TOUCH GESTURE LOGIC ---
            const handleTouchStart = (e) => {
                const t = e.touches;
                if (t.length === 1) {
                    gestureStart.current = { mode: 'pan', x: t[0].clientX, y: t[0].clientY, imgX: imgPos.x, imgY: imgPos.y };
                } else if (t.length === 2) {
                    const dist = Math.hypot(t[0].clientX - t[1].clientX, t[0].clientY - t[1].clientY);
                    gestureStart.current = { mode: 'zoom', dist: dist, scale: imgPos.scale };
                }
            };

            const handleTouchMove = (e) => {
                if (!gestureStart.current.mode) return;
                e.preventDefault(); 
                const rect = e.target.getBoundingClientRect();
                const canvasScaleFactor = 1080 / rect.width; 
                const t = e.touches;
                
                if (t.length === 1 && gestureStart.current.mode === 'pan') {
                    const dx = (t[0].clientX - gestureStart.current.x) * canvasScaleFactor;
                    const dy = (t[0].clientY - gestureStart.current.y) * canvasScaleFactor;
                    setImgPos(prev => ({ ...prev, x: gestureStart.current.imgX + dx, y: gestureStart.current.imgY + dy }));
                } else if (t.length === 2 && gestureStart.current.mode === 'zoom') {
                    const dist = Math.hypot(t[0].clientX - t[1].clientX, t[0].clientY - t[1].clientY);
                    const scaleChange = dist / gestureStart.current.dist;
                    setImgPos(prev => ({ ...prev, scale: gestureStart.current.scale * scaleChange }));
                }
            };

            const handleEnd = () => { gestureStart.current.mode = null; };
            const handleMouseDown = (e) => { gestureStart.current = { mode: 'pan', x: e.clientX, y: e.clientY, imgX: imgPos.x, imgY: imgPos.y }; };
            const handleMouseMove = (e) => {
                if (gestureStart.current.mode === 'pan') {
                    const rect = e.target.getBoundingClientRect();
                    const canvasScaleFactor = 1080 / rect.width;
                    const dx = (e.clientX - gestureStart.current.x) * canvasScaleFactor;
                    const dy = (e.clientY - gestureStart.current.y) * canvasScaleFactor;
                    setImgPos(prev => ({ ...prev, x: gestureStart.current.imgX + dx, y: gestureStart.current.imgY + dy }));
                }
            };

            // --- CANVAS LOGIC ---
            const measureText = (ctx, text, fontSize, fontWeight = 'bold') => {
                ctx.font = `${fontWeight} ${fontSize}px "Hind Siliguri", sans-serif`;
                return ctx.measureText(text).width;
            };

            // Wrap text helper for News
            const wrapText = (ctx, text, x, y, maxWidth, lineHeight) => {
                const words = text.split(' ');
                let line = '';
                let testLine = '';
                let lineCount = 0;
                
                for(let n = 0; n < words.length; n++) {
                    testLine = line + words[n] + ' ';
                    const metrics = ctx.measureText(testLine);
                    const testWidth = metrics.width;
                    if (testWidth > maxWidth && n > 0) {
                        ctx.fillText(line, x, y);
                        line = words[n] + ' ';
                        y += lineHeight;
                        lineCount++;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, x, y);
            };

            const drawText = (ctx, text, x, y, fontSize, color, align = 'center', fontWeight = 'bold') => {
                ctx.font = `${fontWeight} ${fontSize}px "Hind Siliguri", sans-serif`;
                ctx.fillStyle = color;
                ctx.textAlign = align;
                ctx.fillText(text, x, y);
            };

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const W = 1080;
                const H = 1200;
                const splitY = 700;
                canvas.width = W;
                canvas.height = H;

                // 1. Background
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, W, H);

                // 2. Image (with Default)
                if (bgImage) {
                    ctx.save();
                    ctx.translate(imgPos.x, imgPos.y);
                    ctx.scale(imgPos.scale, imgPos.scale);
                    ctx.drawImage(bgImage, 0, 0);
                    ctx.restore();
                } else {
                    const grd = ctx.createLinearGradient(0, 0, 0, splitY);
                    grd.addColorStop(0, '#1b5e20'); grd.addColorStop(1, '#2e7d32');
                    ctx.fillStyle = grd; ctx.fillRect(0, 0, W, H);
                    drawText(ctx, "Loading Image...", W/2, H/2, 50, "#fff", "center");
                }

                // 3. Info Section Overlay
                ctx.save();
                ctx.globalAlpha = formData.bgOpacity; 
                const gradient = ctx.createLinearGradient(0, splitY, 0, H);
                gradient.addColorStop(0, formData.primaryColor); 
                gradient.addColorStop(1, formData.secondaryColor);
                ctx.fillStyle = gradient;
                
                if (appMode === 'news') {
                    ctx.fillRect(0, 500, W, H - 500); 
                } else {
                    ctx.fillRect(0, splitY, W, H - splitY);
                }
                
                // Define variables accessible to all blocks
                const titleBoxY = splitY + 40; 
                const titleBoxW = 800;
                const titleBoxH = 90;
                const titleBoxX = (W - titleBoxW) / 2;

                // Header Box (Only for Scorecard/Schedule)
                if (appMode !== 'news') {
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
                    ctx.fillRect(titleBoxX, titleBoxY, titleBoxW, titleBoxH);
                }
                
                const footerH = 60;
                const footerY = H - footerH;
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, footerY, W, footerH);
                ctx.restore(); 

                // 4. Badge & Social Icon
                const badgeW = 320;
                const badgeH = 70;
                const badgeX = W - badgeW - 40;
                const badgeY = 40;
                
                ctx.beginPath();
                ctx.arc(badgeX + 45, badgeY + 35, 22, 0, Math.PI * 2);
                ctx.fillStyle = '#1877F2';
                ctx.fill();
                drawText(ctx, "f", badgeX + 45, badgeY + 48, 35, "#fff", "center", "bold");
                
                ctx.save();
                ctx.shadowColor = "rgba(0, 0, 0, 0.8)";
                ctx.shadowBlur = 6;
                drawText(ctx, formData.badgeText, badgeX + 80, badgeY + 48, 32, '#fff', 'left', 'bold');
                ctx.restore();

                // 5. Borders & Title (Not for News)
                if (appMode !== 'news') {
                    ctx.strokeStyle = 'rgba(255,255,255,0.4)';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(titleBoxX, titleBoxY, titleBoxW, titleBoxH);
                    drawText(ctx, formData.title, W / 2, titleBoxY + 60, 50, '#fff', 'center', 'bold');
                }

                // 6. CONTENT LOGIC
                const scoresY = titleBoxY + 160; 
                const leftCenter = W * 0.25; 
                const rightCenter = W * 0.75;

                if (appMode === 'scorecard') {
                    // --- SCORECARD ---
                    drawText(ctx, formData.team1, leftCenter, scoresY, 65, formData.team1Color, 'center', 'bold');
                    const t1w = measureText(ctx, formData.team1Score, 60, 'bold');
                    const t1o = measureText(ctx, formData.team1Overs, 35, 'normal');
                    const t1x = leftCenter - ((t1w + 15 + t1o) / 2);
                    ctx.textAlign = 'left';
                    ctx.font = `bold 60px "Hind Siliguri", sans-serif`; ctx.fillStyle = '#fff'; ctx.fillText(formData.team1Score, t1x, scoresY + 80);
                    ctx.font = `normal 35px "Hind Siliguri", sans-serif`; ctx.fillStyle = '#ddd'; ctx.fillText(formData.team1Overs, t1x + t1w + 15, scoresY + 80);

                    ctx.beginPath(); ctx.moveTo(W/2, scoresY-20); ctx.lineTo(W/2, scoresY+100); ctx.lineWidth=4; ctx.strokeStyle='rgba(255,255,255,0.3)'; ctx.stroke();

                    drawText(ctx, formData.team2, rightCenter, scoresY, 65, formData.team2Color, 'center', 'bold');
                    const t2w = measureText(ctx, formData.team2Score, 60, 'bold');
                    const t2o = measureText(ctx, formData.team2Overs, 35, 'normal');
                    const t2x = rightCenter - ((t2w + 15 + t2o) / 2);
                    ctx.textAlign = 'left';
                    ctx.font = `bold 60px "Hind Siliguri", sans-serif`; ctx.fillStyle = '#fff'; ctx.fillText(formData.team2Score, t2x, scoresY + 80);
                    ctx.font = `normal 35px "Hind Siliguri", sans-serif`; ctx.fillStyle = '#ddd'; ctx.fillText(formData.team2Overs, t2x + t2w + 15, scoresY + 80);

                    drawText(ctx, formData.result, W / 2, scoresY + 180, 48, formData.resultColor, 'center', 'bold');

                } else if (appMode === 'schedule') {
                    // --- SCHEDULE ---
                    drawText(ctx, formData.team1, leftCenter - 20, scoresY + 40, 80, formData.team1Color, 'center', 'bold');
                    ctx.beginPath(); ctx.arc(W / 2, scoresY + 30, 50, 0, Math.PI * 2); ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fill();
                    ctx.lineWidth = 3; ctx.strokeStyle = '#fff'; ctx.stroke();
                    drawText(ctx, "VS", W / 2, scoresY + 45, 40, '#fff', 'center', 'bold');
                    drawText(ctx, formData.team2, rightCenter + 20, scoresY + 40, 80, formData.team2Color, 'center', 'bold');

                    const detailsY = scoresY + 130;
                    ctx.fillStyle = 'rgba(0,0,0,0.3)';
                    if(ctx.roundRect) ctx.roundRect((W-700)/2, detailsY, 700, 100, 20); else ctx.fillRect((W-700)/2, detailsY, 700, 100);
                    ctx.fill();

                    drawText(ctx, formData.matchDate, W / 2, detailsY + 45, 40, '#fff', 'center', 'bold');
                    drawText(ctx, `${formData.matchTime}  |  ${formData.matchVenue}`, W / 2, detailsY + 85, 30, '#ddd', 'center', 'normal');

                } else if (appMode === 'player') {
                    // --- PLAYER STATS (Simplified: Run & Ball) ---
                    const pStatY = scoresY - 20; 
                    drawText(ctx, formData.playerStatMain, W/2, pStatY + 40, 130, formData.team1Color, 'center', 'bold'); 
                    drawText(ctx, formData.playerStatSub, W/2, pStatY + 90, 40, '#fff', 'center', 'normal');

                    ctx.beginPath(); ctx.moveTo(W/2 - 200, pStatY + 110); ctx.lineTo(W/2 + 200, pStatY + 110); 
                    ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 2; ctx.stroke();

                    // Removed the 3-column stats grid here

                    drawText(ctx, formData.playerName, W/2, H - footerH - 40, 60, '#fff', 'center', 'bold'); 

                } else if (appMode === 'news') {
                    // --- NEWS CARD ---
                    const newsY = 600;
                    ctx.font = "100px serif"; ctx.fillStyle = "rgba(255,215,0,0.2)"; ctx.textAlign = "left";
                    ctx.fillText("❝", 80, newsY);

                    ctx.font = "bold 55px 'Hind Siliguri', sans-serif";
                    ctx.fillStyle = "#fff";
                    ctx.textAlign = "left";
                    wrapText(ctx, formData.quoteText, 100, newsY + 60, 880, 80);

                    const authY = H - 250;
                    ctx.beginPath(); ctx.moveTo(100, authY); ctx.lineTo(300, authY);
                    ctx.strokeStyle = formData.team1Color; ctx.lineWidth = 5; ctx.stroke();

                    drawText(ctx, formData.quoteAuthor, 100, authY + 50, 40, '#ddd', 'left', 'bold');
                    
                    ctx.fillStyle = '#d32f2f';
                    ctx.fillRect(80, newsY - 120, 300, 60);
                    drawText(ctx, "ব্রেকিং নিউজ", 230, newsY - 80, 35, '#fff', 'center', 'bold');
                }

                // 8. Footer
                drawText(ctx, formData.footerHandle, W / 2, footerY + 40, 24, '#94a3b8', 'center', 'normal');

            }, [bgImage, formData, imgPos, appMode]);

            const handleChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const swapTeams = () => {
                setFormData(prev => ({
                    ...prev,
                    team1: prev.team2,
                    team1Score: prev.team2Score,
                    team1Overs: prev.team2Overs,
                    team1Color: prev.team2Color,
                    team2: prev.team1,
                    team2Score: prev.team1Score,
                    team2Overs: prev.team1Overs,
                    team2Color: prev.team1Color,
                }));
            };

            // --- AD & DOWNLOAD LOGIC ---
            const handleDownloadClick = () => { setShowAdModal(true); };
            const incrementAdCount = () => { setIsLoadingAd(false); setAdsWatched(prev => { const newCount = prev + 1; if (newCount >= 3) setIsDownloadReady(true); return newCount; }); };
            const watchAd = () => {
                setIsLoadingAd(true);
                const adTimeout = setTimeout(() => { incrementAdCount(); }, 5000);
                if (typeof window.show_9743120 !== 'function') { clearTimeout(adTimeout); setTimeout(() => incrementAdCount(), 1500); return; }
                window.show_9743120().then(() => { clearTimeout(adTimeout); incrementAdCount(); }).catch(err => { clearTimeout(adTimeout); incrementAdCount(); });
            };
            const performDownload = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                canvas.toBlob((blob) => {
                    if (!blob) { alert("Error generating image."); return; }
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `poster-${Date.now()}.png`;
                    link.href = url;
                    document.body.appendChild(link); link.click();
                    setTimeout(() => { document.body.removeChild(link); URL.revokeObjectURL(url); }, 100);
                }, 'image/png');
            };
            const handleFinalDownload = () => { performDownload(); setTimeout(() => { setShowAdModal(false); setAdsWatched(0); setIsDownloadReady(false); }, 1500); };

            return (
                <div className="min-h-screen pb-20 md:pb-8">
                    {/* AD MODAL */}
                    {showAdModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm modal-backdrop">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center modal-content border border-gray-200">
                                <div className="bg-red-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                    {isDownloadReady ? <IconCheck /> : <IconDownload />}
                                </div>
                                <h3 className="text-xl font-bold text-gray-900 mb-2">{isDownloadReady ? 'Ready to Save!' : 'Free Download'}</h3>
                                <p className="text-gray-500 text-sm mb-6">{isDownloadReady ? "Click below to save." : "Watch 3 short ads to download your poster."}</p>
                                {!isDownloadReady && (
                                    <>
                                        <div className="mb-6 bg-gray-200 rounded-full h-4 overflow-hidden">
                                            <div className="bg-red-600 h-full transition-all duration-500 ease-out" style={{ width: `${(adsWatched / 3) * 100}%` }}></div>
                                        </div>
                                        <p className="text-sm font-bold text-gray-700 mb-6">Ads Watched: <span className="text-red-600">{adsWatched} / 3</span></p>
                                    </>
                                )}
                                {isDownloadReady ? (
                                    <button onClick={handleFinalDownload} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"><IconDownload /> Download Now</button>
                                ) : (
                                    <button onClick={watchAd} disabled={isLoadingAd} className="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 disabled:opacity-70">{isLoadingAd ? 'Loading Ad...' : 'Watch Ad'} {!isLoadingAd && <IconPlay />}</button>
                                )}
                                <button onClick={() => setShowAdModal(false)} className="mt-4 text-xs text-gray-400 hover:text-gray-600 underline">Cancel</button>
                            </div>
                        </div>
                    )}

                    {/* Navbar */}
                    <div className="bg-white border-b sticky top-0 z-20 px-4 py-3 flex items-center justify-between shadow-sm">
                        <h1 className="text-lg font-bold text-slate-800 flex items-center gap-2"><span className="text-red-600 bg-red-100 p-1.5 rounded-lg"><IconRefresh /></span> Poster Bot</h1>
                        <button onClick={handleDownloadClick} className="bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 active:scale-95 transition-transform"><IconDownload /> Save</button>
                    </div>

                    <div className="max-w-2xl mx-auto p-4 space-y-6">
                        
                        {/* MODE SWITCHER */}
                        <div className="bg-white p-1.5 rounded-xl shadow-sm border border-slate-200 flex gap-1 overflow-x-auto no-scrollbar">
                            {['scorecard', 'schedule', 'player', 'news'].map(mode => (
                                <button key={mode} onClick={() => setAppMode(mode)} className={`flex-1 min-w-[80px] py-2.5 rounded-lg text-xs font-bold uppercase tracking-wider transition-all ${appMode === mode ? 'bg-red-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'}`}>
                                    {mode}
                                </button>
                            ))}
                        </div>

                        {/* Canvas */}
                        <div className="bg-slate-800 rounded-xl overflow-hidden shadow-2xl border border-slate-700 aspect-[1080/1200] relative group canvas-container touch-none">
                            <canvas ref={canvasRef} className="w-full h-full object-contain cursor-move touch-none" onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleEnd} onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleEnd} onMouseLeave={handleEnd}></canvas>
                            <div className="absolute top-4 right-4"><button onClick={resetImage} className="bg-black/50 text-white p-2 rounded-full backdrop-blur-sm hover:bg-black/70"><IconRefresh /></button></div>
                            {!bgImage && <div className="absolute inset-0 pointer-events-none flex items-center justify-center"><span className="bg-white/90 text-slate-800 px-4 py-2 rounded-full text-sm font-bold shadow-lg">Loading Default Image...</span></div>}
                        </div>

                        {/* Controls */}
                        {bgImage && (
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center gap-4">
                                <IconMove /> <span className="text-xs text-slate-500 font-medium w-24">Drag Image</span>
                                <div className="h-6 w-px bg-slate-200"></div> <IconZoomIn />
                                <input type="range" min="0.1" max="5" step="0.05" value={imgPos.scale} onChange={(e) => setImgPos(prev => ({ ...prev, scale: parseFloat(e.target.value) }))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                            </div>
                        )}

                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="flex border-b bg-slate-50">
                                <button onClick={() => setActiveTab('match')} className={`flex-1 py-3 text-sm font-medium ${activeTab === 'match' ? 'bg-white text-red-600 border-t-2 border-red-600' : 'text-slate-500'}`}>Edit Info</button>
                                {appMode !== 'player' && appMode !== 'news' && <button onClick={() => setActiveTab('teams')} className={`flex-1 py-3 text-sm font-medium ${activeTab === 'teams' ? 'bg-white text-red-600 border-t-2 border-red-600' : 'text-slate-500'}`}>Teams</button>}
                                <button onClick={() => setActiveTab('style')} className={`flex-1 py-3 text-sm font-medium ${activeTab === 'style' ? 'bg-white text-red-600 border-t-2 border-red-600' : 'text-slate-500'}`}>Style</button>
                            </div>

                            <div className="p-5 space-y-4">
                                {activeTab === 'match' && (
                                    <>
                                        <div className="relative group">
                                            <input type="file" accept="image/*" onChange={handleImageUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                            <div className="border-2 border-dashed border-slate-300 rounded-lg p-4 flex items-center justify-center gap-3 bg-slate-50 group-hover:bg-slate-100 transition-colors">
                                                <div className="bg-white p-2 rounded-full shadow-sm text-slate-600"><IconUpload /></div>
                                                <div className="text-left"><p className="text-sm font-semibold text-slate-700">Change Photo</p></div>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="text" name="badgeText" value={formData.badgeText} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Badge" />
                                            {appMode !== 'news' && <input type="text" name="title" value={formData.title} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Tournament" />}
                                        </div>

                                        {appMode === 'scorecard' && (
                                            <textarea name="result" value={formData.result} onChange={handleChange} rows="2" className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Result Text"></textarea>
                                        )}

                                        {appMode === 'schedule' && (
                                            <div className="p-3 bg-slate-50 rounded-lg border space-y-3">
                                                <h4 className="text-xs font-bold text-slate-500 uppercase flex items-center gap-2"><IconCalendar /> Match Details</h4>
                                                <input type="text" name="matchDate" value={formData.matchDate} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Date" />
                                                <div className="grid grid-cols-2 gap-3">
                                                    <input type="text" name="matchTime" value={formData.matchTime} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Time" />
                                                    <input type="text" name="matchVenue" value={formData.matchVenue} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Venue" />
                                                </div>
                                            </div>
                                        )}

                                        {appMode === 'player' && (
                                            <div className="p-3 bg-amber-50 rounded-lg border border-amber-100 space-y-3">
                                                <h4 className="text-xs font-bold text-amber-700 uppercase flex items-center gap-2"><IconUser /> Player Stats</h4>
                                                <input type="text" name="playerName" value={formData.playerName} onChange={handleChange} className="w-full px-3 py-2 bg-white border border-amber-200 rounded-lg text-sm font-bold" placeholder="Player Name" />
                                                
                                                <div className="grid grid-cols-2 gap-3">
                                                    <input type="text" name="playerStatMain" value={formData.playerStatMain} onChange={handleChange} className="w-full px-3 py-2 bg-white border border-amber-200 rounded-lg text-xl font-bold text-center" placeholder="Main (e.g. 50)" />
                                                    <input type="text" name="playerStatSub" value={formData.playerStatSub} onChange={handleChange} className="w-full px-3 py-2 bg-white border border-amber-200 rounded-lg text-sm" placeholder="Sub (e.g. 30 balls)" />
                                                </div>
                                            </div>
                                        )}

                                        {appMode === 'news' && (
                                            <div className="p-3 bg-red-50 rounded-lg border border-red-100 space-y-3">
                                                <h4 className="text-xs font-bold text-red-700 uppercase flex items-center gap-2"><IconQuote /> Breaking News / Quote</h4>
                                                <textarea name="quoteText" value={formData.quoteText} onChange={handleChange} rows="3" className="w-full px-3 py-2 bg-white border border-red-200 rounded-lg text-sm" placeholder="Quote or News Body"></textarea>
                                                <input type="text" name="quoteAuthor" value={formData.quoteAuthor} onChange={handleChange} className="w-full px-3 py-2 bg-white border border-red-200 rounded-lg text-sm font-bold" placeholder="Headline or Author" />
                                            </div>
                                        )}
                                    </>
                                )}

                                {activeTab === 'teams' && appMode !== 'player' && appMode !== 'news' && (
                                    <div className="space-y-5">
                                        <button onClick={swapTeams} className="w-full py-2 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold uppercase flex items-center justify-center gap-2"><IconSwap /> Swap Sides</button>
                                        <div className="bg-amber-50 p-4 rounded-xl border border-amber-100 space-y-3">
                                            <div className="flex justify-between"><h3 className="text-xs font-bold text-amber-800">Left Team</h3><input type="color" name="team1Color" value={formData.team1Color} onChange={handleChange} className="w-6 h-6 rounded-full overflow-hidden border-none" /></div>
                                            <input type="text" name="team1" value={formData.team1} onChange={handleChange} className="w-full px-3 py-2 bg-white border border-amber-200 rounded-lg text-sm font-bold" />
                                            {appMode === 'scorecard' && <div className="flex gap-2"><input type="text" name="team1Score" value={formData.team1Score} onChange={handleChange} className="flex-1 px-3 py-2 bg-white border rounded-lg text-sm" /><input type="text" name="team1Overs" value={formData.team1Overs} onChange={handleChange} className="w-24 px-3 py-2 bg-white border rounded-lg text-sm" /></div>}
                                        </div>
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3">
                                            <div className="flex justify-between"><h3 className="text-xs font-bold text-blue-800">Right Team</h3><input type="color" name="team2Color" value={formData.team2Color} onChange={handleChange} className="w-6 h-6 rounded-full overflow-hidden border-none" /></div>
                                            <input type="text" name="team2" value={formData.team2} onChange={handleChange} className="w-full px-3 py-2 bg-white border border-blue-200 rounded-lg text-sm font-bold" />
                                            {appMode === 'scorecard' && <div className="flex gap-2"><input type="text" name="team2Score" value={formData.team2Score} onChange={handleChange} className="flex-1 px-3 py-2 bg-white border rounded-lg text-sm" /><input type="text" name="team2Overs" value={formData.team2Overs} onChange={handleChange} className="w-24 px-3 py-2 bg-white border rounded-lg text-sm" /></div>}
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'style' && (
                                    <div className="space-y-5">
                                        <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-2"><IconEye /> Opacity</label><input type="range" min="0" max="1" step="0.05" value={formData.bgOpacity} onChange={(e) => setFormData({...formData, bgOpacity: parseFloat(e.target.value)})} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" /></div>
                                        <div><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Gradient</label><div className="flex gap-2"><input type="color" name="primaryColor" value={formData.primaryColor} onChange={handleChange} className="h-10 w-full rounded-lg" /><input type="color" name="secondaryColor" value={formData.secondaryColor} onChange={handleChange} className="h-10 w-full rounded-lg" /></div></div>
                                        <input type="text" name="footerHandle" value={formData.footerHandle} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Footer Text" />
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
